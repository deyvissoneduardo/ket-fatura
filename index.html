<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ’—</title>

<!-- TAILWIND CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  /* Cores fofas personalizadas */
  .cor-laranja { background-color: #FFD8A8 !important; }
  .cor-rosa { background-color: #FFBDE6 !important; }
  .cor-cinza { background-color: #E5E5E5 !important; }
</style>

</head>

<body class="bg-pink-50 min-h-screen p-8 font-sans">

<div class="max-w-5xl mx-auto bg-white shadow-xl rounded-2xl p-8 border border-pink-200">

  <h1 class="text-4xl font-bold text-pink-600 mb-6 text-center drop-shadow-sm">
    ðŸ’— Ket Maravilhosa ðŸ’—
  </h1>

  <label class="block mb-4 font-medium text-pink-700">
    Selecione o PDF da Fatura:
  </label>

  <input
    id="pdfInput"
    type="file"
    accept="application/pdf"
    class="w-full p-3 border border-pink-300 rounded-xl bg-pink-100 text-pink-700 cursor-pointer hover:bg-pink-200 transition"
  />

  <!-- TABELA -->
  <div id="tableWrapper" class="mt-10 hidden">
    <table class="w-full border border-pink-200 rounded-xl overflow-hidden shadow-md">
      <thead>
        <tr class="bg-pink-300 text-pink-900 font-semibold">
          <th class="p-3">Cor</th>
          <th class="p-3">Data</th>
          <th class="p-3">Loja / DescriÃ§Ã£o</th>
          <th class="p-3">Valor Original</th>
          <th class="p-3">LanÃ§amento do MÃªs</th>
        </tr>
      </thead>
      <tbody id="tableBody" class="bg-white"></tbody>
    </table>
  </div>

  <!-- TOTALIZADORES -->
  <div id="totaisContainer" class="mt-10 p-6 bg-pink-100 rounded-xl shadow-inner hidden">
    <h2 class="text-xl font-bold text-pink-700 mb-4">Totais por cor ðŸŒˆ</h2>

    <p class="text-pink-800 font-medium">
      ðŸ§¡ Total MÃ£e: <span id="totalLaranja" class="font-bold">R$ 0,00</span>
    </p>
    <p class="text-pink-800 font-medium">
      ðŸ’— Total Ket: <span id="totalRosa" class="font-bold">R$ 0,00</span>
    </p>
    <p class="text-pink-800 font-medium">
      ðŸ©¶ Total Lucas: <span id="totalCinza" class="font-bold">R$ 0,00</span>
    </p>
  </div>

</div>

<script>
/* --------------------
   UPLOAD DO PDF
-------------------- */
document.getElementById("pdfInput").addEventListener("change", handlePDF);

async function handlePDF(event) {
  const file = event.target.files[0];
  if (!file) return;

  const pdfData = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

  let full = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    full += c.items.map(x => x.str).join(" ") + "\n";
  }

  parsePDF(full);
}

/* --------------------
   PARSE DO PDF
-------------------- */
function parsePDF(text) {
  text = text.replace(/\s+/g, " ").trim();
  const partes = text.split(/(?=\d{2}\/\d{2}\/\d{2} 223|\d{2}\/\d{2}\/\d{2} 037|\d{2}\/\d{2}\/\d{2} 034)/g);

  let lista = [];

  partes.forEach(chunk => {
    const mData = chunk.match(/^(\d{2}\/\d{2}\/\d{2})/);
    if (!mData) return;

    const data = mData[1];
    const valorOriginal = chunk.match(/(\d{1,3}(?:\.\d{3})*,\d{2})/)?.[1] || "";
    const lancamento = chunk.match(/\+\s*(\d{1,3}(?:\.\d{3})*,\d{2})/)?.[1] || "";

    let descricao = chunk
      .replace(data, "")
      .replace(/^\s*\d{3}\s*/, "")
      .replace(valorOriginal, "")
      .replace("+" + lancamento, "")
      .trim();

    lista.push({ data, descricao, valorOriginal, lancamento });
  });

  fillTable(lista);
}

/* --------------------
   PREENCHER TABELA
-------------------- */
function fillTable(lista) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  document.getElementById("tableWrapper").classList.remove("hidden");
  document.getElementById("totaisContainer").classList.remove("hidden");

  lista.forEach((item, index) => {
    const tr = document.createElement("tr");

    tr.className = "border-b border-pink-200 hover:bg-pink-50 transition";

    tr.innerHTML = `
      <td class="p-3">
        <select
          class="corSelect p-2 rounded-lg bg-pink-200 text-pink-800 border border-pink-300"
        >
          <option value="">Nenhuma</option>
          <option value="laranja">MÃ£e</option>
          <option value="rosa">Ket</option>
          <option value="cinza">Lucas</option>
        </select>
      </td>

      <td class="p-3">${item.data}</td>
      <td class="p-3">${item.descricao}</td>
      <td class="p-3">${item.valorOriginal}</td>
      <td class="p-3 valorLanc">${item.lancamento}</td>
    `;

    tbody.appendChild(tr);
  });

  document.querySelectorAll(".corSelect").forEach(sel => {
    sel.addEventListener("change", atualizarTotais);
  });
}

/* --------------------
   SOMATÃ“RIO POR COR
-------------------- */
function atualizarTotais() {

  const rows = document.querySelectorAll("#tableBody tr");

  let totalLaranja = 0;
  let totalRosa = 0;
  let totalCinza = 0;

  rows.forEach(row => {
    const cor = row.querySelector("select").value;
    const valorTxt = row.querySelector(".valorLanc")?.innerText || "";
    const valor = parseFloat(valorTxt.replace(".", "").replace(",", "."));

    // limpar cor
    row.classList.remove("cor-laranja", "cor-rosa", "cor-cinza");

    if (cor === "laranja") {
      row.classList.add("cor-laranja");
      totalLaranja += valor;
    }
    if (cor === "rosa") {
      row.classList.add("cor-rosa");
      totalRosa += valor;
    }
    if (cor === "cinza") {
      row.classList.add("cor-cinza");
      totalCinza += valor;
    }
  });

  document.getElementById("totalLaranja").innerText = totalLaranja.toFixed(2).replace(".", ",");
  document.getElementById("totalRosa").innerText = totalRosa.toFixed(2).replace(".", ",");
  document.getElementById("totalCinza").innerText = totalCinza.toFixed(2).replace(".", ",");
}
</script>

</body>
</html>
